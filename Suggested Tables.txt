CREATE TABLE Admin (
    admin_id INT IDENTITY(1,1) PRIMARY KEY ,
    email VARCHAR(255) UNIQUE,
    password VARCHAR(255),
    name VARCHAR(255),
    phone VARCHAR(20)
);

CREATE TABLE Passenger (
    passenger_id INT IDENTITY(1,1) PRIMARY KEY ,
    email VARCHAR(255) UNIQUE,
    password VARCHAR(255),
    name VARCHAR(255),
    phone VARCHAR(20),
    age INT,
    gender VARCHAR(10)
);

CREATE TABLE Train (
    train_id INT IDENTITY(1,1) PRIMARY KEY ,
    train_model VARCHAR(255),
    capacity INT
);

CREATE TABLE Stations (
    station_id INT IDENTITY(1,1) PRIMARY KEY,
    name VARCHAR(255),
    location VARCHAR(255)
);


CREATE TABLE Seats (
    train_id INT,
    seat_number INT,
    seat_tier VARCHAR(20),
    is_valid BIT,
    trip_id INT,
    PRIMARY KEY (train_id, seat_number),
    FOREIGN KEY (train_id) REFERENCES Train(train_id) ON DELETE CASCADE,
    FOREIGN KEY (trip_id) REFERENCES Trip(trip_id)
);

CREATE TABLE Trip (
    trip_id INT IDENTITY(1,1) PRIMARY KEY ,
    departure_time DATETIME,
    arrival_time DATETIME,
    start_station_id INT,
    end_station_id INT,
    train_id INT,
    FOREIGN KEY (train_id) REFERENCES Train(train_id) ON DELETE CASCADE,
    FOREIGN KEY (start_station_id) REFERENCES Stations(station_id),
    FOREIGN KEY (end_station_id) REFERENCES Stations(station_id),
);


CREATE TABLE Ticket (
    ticket_id INT IDENTITY(1,1) PRIMARY KEY ,
    price NUMERIC(10,2),
    tier VARCHAR(20),
    is_valid BIT,
    start_station_id INT,
    end_station_id INT,
	trip_id INT,
    FOREIGN KEY (start_station_id) REFERENCES Stations(station_id),
    FOREIGN KEY (end_station_id) REFERENCES Stations(station_id),
    FOREIGN KEY (trip_id) REFERENCES Trip(trip_id) ON DELETE CASCADE
);

CREATE TABLE Manage (
    admin_id INT,
    trip_id INT,
    train_id INT,
    PRIMARY KEY (admin_id, trip_id),
    FOREIGN KEY (admin_id) REFERENCES Admin(admin_id),
    FOREIGN KEY (trip_id) REFERENCES Trip(trip_id) ON DELETE CASCADE,
);

CREATE TABLE Buy (
    passenger_id INT,
    ticket_id INT,
    train_id INT,
    seat_number INT,
    PRIMARY KEY (passenger_id, ticket_id),
    FOREIGN KEY (passenger_id) REFERENCES Passenger(passenger_id) ON DELETE CASCADE,
    FOREIGN KEY (ticket_id) REFERENCES Ticket(ticket_id) ON DELETE CASCADE,
);

CREATE FUNCTION dbo.GetNumPassengersForTrip(@trip_id INT)
RETURNS INT
AS
BEGIN
    DECLARE @num_passengers INT;
    SELECT @num_passengers = COUNT(*)
    FROM Ticket
    WHERE trip_id = @trip_id;
    RETURN @num_passengers;
END;
GO -- Add a semicolon to end the function definition

-- Add a computed column to the Trip table to use the user-defined function
ALTER TABLE Trip
ADD num_passengers AS dbo.GetNumPassengersForTrip(trip_id);


/////////////////////////// views //////////////////////////////////////
CREATE VIEW PassengerTripSeatDetails AS
SELECT 
    p.name AS passenger_name,
    p.email AS passenger_email,
    s1.name AS from_station,
    s2.name AS to_station,
    t.departure_time,
    t.arrival_time,
    s.seat_number,
    s.seat_tier
FROM 
    Passenger p
INNER JOIN 
    Buy b ON p.passenger_id = b.passenger_id
INNER JOIN 
    Ticket tk ON b.ticket_id = tk.ticket_id
INNER JOIN 
    Trip t ON tk.trip_id = t.trip_id
INNER JOIN 
    Train tr ON t.train_id = tr.train_id
INNER JOIN 
    Seats s ON tr.train_id = s.train_id
           AND s.seat_number = b.seat_number
INNER JOIN 
    Stations s1 ON tk.start_station_id = s1.station_id
INNER JOIN 
    Stations s2 ON tk.end_station_id = s2.station_id;





CREATE VIEW PassengerTicketsByEmail AS
SELECT
                            tk.ticket_id,
                            p.name AS passenger_name,
                            p.email AS passenger_email,
                            s1.name AS from_station,
                            s2.name AS to_station,
                            t.departure_time,
                            t.arrival_time,
                            s.seat_number,
                            s.seat_tier
                        FROM 
                            Passenger p
                        INNER JOIN 
                            Buy b ON p.passenger_id = b.passenger_id
                        INNER JOIN 
                            Ticket tk ON b.ticket_id = tk.ticket_id
                        INNER JOIN 
                            Trip t ON tk.trip_id = t.trip_id
                        INNER JOIN 
                            Train tr ON t.train_id = tr.train_id
                        INNER JOIN 
                            Seats s ON tr.train_id = s.train_id
                                AND s.seat_number = b.seat_number
                        INNER JOIN 
                            Stations s1 ON tk.start_station_id = s1.station_id
                        INNER JOIN 
                            Stations s2 ON tk.end_station_id = s2.station_id
